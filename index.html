<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Compras Evereste</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padrão (similar ao Roboto/Inter) */
        html { font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
        .spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Container Principal do Aplicativo (Montagem) -->
    <div id="app-root" class="min-h-screen">
        <div class="flex items-center justify-center min-h-screen bg-gray-50">
            <div class="text-xl font-medium text-blue-600 animate-pulse">Iniciando aplicação...</div>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, arrayUnion, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ativar logging para debug do Firestore
        setLogLevel('debug');

        // --- Variáveis Globais do Ambiente Canvas (OBRIGATÓRIO) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-eprocurement-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Constantes Globais da Aplicação ---
        const costCenters = ['CC-Financeiro', 'CC-TI', 'CC-Operações', 'CC-Vendas', 'CC-RH'];
        const units = ['un', 'kg', 'm', 'serv', 'pacote', 'caixa', 'lt'];
        const PR_STATUSES = {
            DRAFT: 'Rascunho',
            SUBMITTED: 'Submetida',
            PENDING_N1: 'Aprovacao_N1_Pendente',
            PENDING_N2: 'Aprovacao_N2_Pendente',
            APPROVED_FOR_SOURCING: 'Aprovada_para_Cotacao',
            REJECTED: 'Rejeitada',
            OC_ISSUED: 'OC_Emitida',
            DELIVERED_PARCIAL: 'Entregue_Parcial',
            DELIVERED_TOTAL: 'Entregue_Total',
        };
        const AVAILABLE_ROLES = {
            SOLICITANTE: 'Solicitante',
            APROVADOR_N1: 'Aprovador N1',
            APROVADOR_N2: 'Aprovador N2',
            COMPRAS: 'Compras',
        };

        // --- Estado Global da Aplicação (Substitui useState do React) ---
        let appState = {
            db: null,
            auth: null,
            userId: null,
            currentUserName: null,
            selectedRole: null,
            isAuthReady: false,
            activeTab: 'pr',
            requisitions: [],
            suppliers: [],
            globalMessage: { text: '', type: '' },
            // Estado para modais (Reprovação, Entrega, Auditoria)
            promptModal: null, 
            showAudit: null,
            selectedPREdit: null,
        };

        // --- Funções Auxiliares de UI e Dados ---

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Se for um objeto Date do cliente ou um Timestamp do Firestore
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('pt-BR');
        };

        const timestampToDateInput = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            return date.toISOString().split('T')[0];
        };

        const getStatusColor = (status) => {
            switch (status) {
                case PR_STATUSES.DRAFT: return 'bg-gray-100 text-gray-700';
                case PR_STATUSES.SUBMITTED:
                case PR_STATUSES.PENDING_N1:
                case PR_STATUSES.PENDING_N2: return 'bg-yellow-100 text-yellow-800';
                case PR_STATUSES.APPROVED_FOR_SOURCING: return 'bg-cyan-100 text-cyan-800';
                case PR_STATUSES.OC_ISSUED: return 'bg-indigo-100 text-indigo-800';
                case PR_STATUSES.DELIVERED_PARCIAL: return 'bg-blue-100 text-blue-800';
                case PR_STATUSES.DELIVERED_TOTAL: return 'bg-green-100 text-green-800';
                case PR_STATUSES.REJECTED: return 'bg-red-100 text-red-800';
                default: return 'bg-gray-200 text-gray-600';
            }
        };

        const checkValidity = (dateStr) => {
            if (!dateStr) return { status: 'Não Informado', color: 'bg-gray-500 text-white' };
            const today = new Date();
            const validDate = new Date(dateStr);
            validDate.setDate(validDate.getDate() + 1); 

            if (validDate < today) {
                return { status: 'Vencida', color: 'bg-red-600 text-white' };
            }
            return { status: 'Válida', color: 'bg-green-500 text-white' };
        };

        // Função para atualizar o estado e redesenhar a aplicação (Simula a re-renderização do React)
        const updateState = (newState = {}) => {
            appState = { ...appState, ...newState };
            renderApp();
        };

        const showGlobalMessage = (text, type = 'success', duration = 5000) => {
            updateState({ globalMessage: { text, type } });
            setTimeout(() => updateState({ globalMessage: { text: '', type: '' } }), duration);
        };

        // --- Funções de Persistência (Firestore) ---

        const getCollectionRef = (collectionName) => {
            if (!appState.db) return null;
            return collection(appState.db, 'artifacts', appId, 'public', 'data', collectionName);
        };

        const createAuditEntry = (action, note, role = appState.selectedRole, level) => ({
            action,
            role: role.split(' ')[0], 
            level: level || role.split(' ').pop(), 
            actor: appState.currentUserName,
            timestamp: new Date(),
            note,
        });

        const createItem = async (collectionName, data, auditNote = 'Criação de documento') => {
            try {
                const colRef = getCollectionRef(collectionName);
                if (colRef) {
                    const audit = createAuditEntry('Criação', auditNote, appState.selectedRole, 'Sistema');
                    await addDoc(colRef, { ...data, createdAt: serverTimestamp(), auditTrail: [audit] });
                    return { success: true };
                }
                return { success: false, error: 'Coleção não encontrada.' };
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                return { success: false, error: e.message };
            }
        };

        const updateItem = async (collectionName, id, data, auditEntry = null) => {
            try {
                const docRef = doc(getCollectionRef(collectionName), id);
                const updateData = { ...data };

                if (auditEntry) {
                    updateData.auditTrail = arrayUnion(auditEntry);
                }

                await updateDoc(docRef, updateData);
                return { success: true };
            } catch (e) {
                console.error("Erro ao atualizar documento: ", e);
                return { success: false, error: e.message };
            }
        };
        
        // --- Handlers de Ação Global ---

        const handleLogin = (role, email) => {
            const userName = `${email.split('@')[0]} (${role})`;
            updateState({ selectedRole: role, currentUserName: userName });
            showGlobalMessage(`Bem-vindo(a), ${userName}! Papel: ${role}.`, 'success', 4000);
        };

        const handleTabChange = (tabId) => {
            updateState({ activeTab: tabId, selectedPREdit: null });
        };
        
        const handleExportCSV = () => {
             const headers = ["ID", "Produto/Serviço", "Qtde Solicitada", "Qtde Recebida", "Status", "Centro de Custo", "Fornecedor Sugerido", "Data Necessidade"];
    
            const csvContent = appState.requisitions.map(pr => [
              pr.id.substring(0, 8),
              `"${pr.produtoServico}"`,
              pr.quantidade,
              pr.quantitiesReceived,
              pr.status,
              pr.centroCusto,
              pr.sugestaoFornecedor,
              pr.dataNecessidade,
            ].join(',')).join('\n');

            const fullCSV = headers.join(',') + '\n' + csvContent;
            const blob = new Blob([fullCSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `requisicoes_evereste_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            showGlobalMessage('PRs exportadas para CSV com sucesso!');
        };


        // --- Renderização de Componentes ---

        function renderGlobalMessage(message) {
            if (!message.text) return '';
            
            let color = '';
            if (message.type === 'error') color = 'bg-red-500';
            else if (message.type === 'loading') color = 'bg-blue-500 animate-pulse';
            else color = 'bg-green-500';

            return `
                <div class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-sm font-semibold text-white ${color}">
                    ${message.text}
                </div>
            `;
        }

        // --- Renderização: LoginScreen ---
        function renderLoginScreen() {
            const userId = appState.userId;
            
            const content = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4 font-sans">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-xl border border-gray-200">
                        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">
                            Sistema de Compras Evereste
                        </h1>
                        <p class="text-center text-sm text-gray-500 mb-8">
                            Autenticado via Firebase (UID: ${userId ? userId.substring(0, 12) : '...'}).
                            Simule o login e selecione seu papel.
                        </p>

                        <form id="login-form" class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                                <input id="email" type="email" value="user-${userId?.substring(0, 8) || 'mock'}@evereste.com" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                <input id="password" type="password" value="123456" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                            </div>

                            <div>
                                <label for="role-select" class="block text-sm font-medium text-gray-700">Papel na Aplicação (Role)</label>
                                <select id="role-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white">
                                    ${Object.values(AVAILABLE_ROLES).map(role => `<option value="${role}">${role}</option>`).join('')}
                                </select>
                            </div>

                            <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                                Entrar no Sistema
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('app-root').innerHTML = content;
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const role = document.getElementById('role-select').value;
                const email = document.getElementById('email').value;
                handleLogin(role, email);
            });
        }
        
        // --- Renderização: DashboardModule ---
        function renderDashboardModule() {
            const { requisitions, suppliers } = appState;
            
            // 1. Cálculos de Métricas
            const totalRequisitions = requisitions.length;
            const submittedCount = requisitions.filter(r => r.status !== PR_STATUSES.DRAFT).length;
            const pendingApproval = requisitions.filter(r => r.status.startsWith('Aprovacao_') || r.status === PR_STATUSES.SUBMITTED).length;
            const ocIssued = requisitions.filter(r => r.status === PR_STATUSES.OC_ISSUED || r.status.startsWith('Entregue_')).length;
            const rejectedCount = requisitions.filter(r => r.status === PR_STATUSES.REJECTED).length;
            const deliveredTotal = requisitions.filter(r => r.status === PR_STATUSES.DELIVERED_TOTAL).length;
            const deliveredPartial = requisitions.filter(r => r.status === PR_STATUSES.DELIVERED_PARCIAL).length;
            const rejectionRate = submittedCount > 0 ? ((rejectedCount / submittedCount) * 100).toFixed(1) : 0;
            
            // 2. Distribuição de Status
            const statusCounts = requisitions.reduce((acc, r) => { acc[r.status] = (acc[r.status] || 0) + 1; return acc; }, {});
            const statusData = Object.keys(statusCounts).map(status => ({
                status: status.replace(/_/g, ' '),
                count: statusCounts[status]
            })).sort((a, b) => b.count - a.count);

            // 3. Top 5 Produtos/Serviços
            const productCounts = requisitions.reduce((acc, r) => { acc[r.produtoServico] = (acc[r.produtoServico] || 0) + r.quantidade; return acc; }, {});
            const topProducts = Object.keys(productCounts)
                .map(name => ({ name, totalQty: productCounts[name] }))
                .sort((a, b) => b.totalQty - a.totalQty)
                .slice(0, 5);
            const totalMaxQty = topProducts[0]?.totalQty || 1;

            // 4. Ranking de Fornecedores por Performance Score
            const rankedSuppliers = [...suppliers].sort((a, b) => b.performanceScore - a.performanceScore);
            
            const Card = (title, value, unit = '', color = 'bg-blue-500') => `
                <div class="p-6 rounded-xl shadow-sm ${color} text-white">
                    <div class="text-sm font-light uppercase">${title}</div>
                    <div class="mt-1 text-4xl font-extrabold">
                        ${value}<span class="text-xl ml-1 font-semibold">${unit}</span>
                    </div>
                </div>`;

            const ChartContainer = (title, content) => `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${title}</h3>
                    ${content}
                </div>`;

            const StatusBar = (status, count, total) => {
                const percentage = total > 0 ? (count / total) * 100 : 0;
                const color = getStatusColor(status.replace(/ /g, '_')).replace('-100', '-500').replace('-200', '-600') || 'bg-gray-400';
                return `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${status}</span>
                            <span>${count} (${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full mt-1 overflow-hidden">
                            <div class="${color} h-2 transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            };

            const BarChartItem = (name, value, totalMax) => {
                const percentage = totalMax > 0 ? (value / totalMax) * 100 : 0;
                return `
                    <div class="flex items-center mb-3">
                        <div class="w-1/3 text-sm text-gray-600 truncate mr-2">${name}</div>
                        <div class="w-2/3 h-6 bg-blue-100 rounded-lg overflow-hidden relative">
                            <div class="bg-blue-600 h-full absolute transition-all duration-500" style="width: ${percentage}%"></div>
                            <span class="absolute right-2 top-0.5 text-xs font-bold text-white drop-shadow-sm">${value}</span>
                        </div>
                    </div>
                `;
            };

            let statusContent = statusData.map(data => StatusBar(data.status, data.count, totalRequisitions)).join('');
            let topProductsContent = topProducts.map(item => BarChartItem(item.name, item.totalQty, totalMaxQty)).join('');
            
            let rankingContent = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead>
                        <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">
                          <th class="px-6 py-3 text-left">Ranking</th>
                          <th class="px-6 py-3 text-left">Razão Social</th>
                          <th class="px-6 py-3 text-left">CNPJ</th>
                          <th class="px-6 py-3 text-center">Score (0-100)</th>
                          <th class="px-6 py-3 text-center">Status</th>
                          <th class="px-6 py-3 text-center">Certidão</th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${rankedSuppliers.map((supplier, index) => {
                            const validity = checkValidity(supplier.validadeCertidao);
                            return `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}º</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${supplier.razaoSocial}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${supplier.cnpj}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-center">${supplier.performanceScore}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${supplier.status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${supplier.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${validity.color}">
                                            ${validity.status}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                      </tbody>
                    </table>
                </div>
                ${suppliers.length === 0 ? '<p class="text-gray-500 italic mt-4">Nenhum fornecedor cadastrado para ranking.</p>' : ''}
            `;


            return `
                <div class="p-6 space-y-8 bg-gray-50 min-h-[calc(100vh-120px)]">
                    <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">Dashboard Executivo</h2>
                    <p class="text-sm text-gray-500">Usuário Logado (${appState.currentUserName}) | Total de Documentos: ${totalRequisitions}</p>

                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 lg:gap-6">
                        ${Card("Requisições Submetidas", submittedCount, '', "bg-indigo-700")}
                        ${Card("Pendentes de Aprovação", pendingApproval, '', "bg-amber-500")}
                        ${Card("OCs/OSs Emitidas", ocIssued, '', "bg-cyan-700")}
                        ${Card("Rejeitadas", rejectedCount, '', "bg-red-700")}
                        ${Card("Entregues Totalmente", deliveredTotal, '', "bg-green-700")}
                        ${Card("Taxa de Rejeição", rejectionRate, '%', "bg-gray-800")}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        ${ChartContainer("Distribuição de Status das Requisições", statusContent)}
                        ${ChartContainer("Top 5 Itens Mais Solicitados (Quantia)", topProductsContent)}
                    </div>

                    ${ChartContainer("Ranking de Fornecedores por Performance Score", rankingContent)}
                </div>
            `;
        }


        // --- Função Principal de Renderização e Inicialização ---
        function renderApp() {
            const root = document.getElementById('app-root');
            
            if (!appState.isAuthReady || !appState.userId) {
                // Estado de carregamento inicial
                root.innerHTML = `<div class="flex items-center justify-center min-h-screen bg-gray-50"><div class="text-xl font-medium text-blue-600 spinner w-8 h-8 rounded-full border-4 border-t-4 border-blue-200"></div><span class="ml-3 text-blue-600">Carregando Firebase...</span></div>`;
                return;
            }

            if (!appState.selectedRole) {
                renderLoginScreen();
                return;
            }

            // Renderiza Mensagem Global
            const messageHtml = renderGlobalMessage(appState.globalMessage);

            // Conteúdo principal
            let mainContentHtml;
            switch (appState.activeTab) {
                case 'dashboard':
                    mainContentHtml = renderDashboardModule();
                    break;
                case 'srm':
                    // TODO: Implementar renderSRMModule
                    mainContentHtml = `<div class="p-6">Módulo SRM em implementação (dados brutos de fornecedores: ${appState.suppliers.length})</div>`;
                    break;
                case 'pr':
                case 'pr_edit':
                    // TODO: Implementar renderPRModule
                    mainContentHtml = `<div class="p-6">Módulo PR em implementação (dados brutos de requisições: ${appState.requisitions.length})</div>`;
                    break;
                case 'oc':
                    // TODO: Implementar renderReceivingModule
                    mainContentHtml = `<div class="p-6">Módulo OC/Recebimento em implementação.</div>`;
                    break;
                default:
                    mainContentHtml = `<div class="p-6">Bem-vindo ao Sistema de Compras Evereste. Selecione uma aba.</div>`;
            }

            // Estrutura completa da Aplicação
            const tabItems = [
                { id: 'pr', label: 'Requisições (PR)' },
                { id: 'srm', label: 'Fornecedores (SRM)' },
                { id: 'oc', label: 'Pedidos/Recebimento' },
                { id: 'dashboard', label: 'Dashboard (KPIs)' },
            ];

            const appHtml = `
                <div class="min-h-screen bg-gray-100 font-sans antialiased">
                    ${messageHtml}

                    <header class="bg-white shadow-sm sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-extrabold text-blue-800">Sistema de Compras Evereste</h1>
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">${appState.currentUserName}</span>
                            </div>
                        </div>
                        <nav class="bg-gray-50 border-t border-gray-200">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-4">
                                ${tabItems.map(item => `
                                    <button
                                        id="tab-${item.id}"
                                        onclick="window.handleTabChange('${item.id}')"
                                        class="py-3 px-4 text-sm font-medium transition duration-150 ${
                                            appState.activeTab === item.id 
                                                ? 'border-b-4 border-blue-600 text-blue-600 bg-white'
                                                : 'text-gray-600 hover:text-blue-500 hover:bg-gray-100'
                                        }"
                                    >
                                        ${item.label}
                                    </button>
                                `).join('')}
                            </div>
                        </nav>
                    </header>

                    <main class="max-w-7xl mx-auto sm:px-6 lg:px-8 py-8">
                        ${mainContentHtml}
                    </main>
                </div>
            `;
            root.innerHTML = appHtml;
        }


        // --- Inicialização da Aplicação ---
        
        function initApp() {
            if (!firebaseConfig) {
                console.error("Configuração do Firebase não encontrada.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const newAuth = getAuth(app);
                const newDb = getFirestore(app);

                appState.auth = newAuth;
                appState.db = newDb;

                onAuthStateChanged(newAuth, (user) => {
                    if (user) {
                        appState.userId = user.uid;
                        appState.currentUserName = `UID-${user.uid.substring(0, 8)}`;
                        appState.isAuthReady = true;
                    } else {
                        if (!appState.isAuthReady) {
                            (async () => {
                                try {
                                    if (initialAuthToken) {
                                        await signInWithCustomToken(newAuth, initialAuthToken);
                                    } else {
                                        await signInAnonymously(newAuth);
                                    }
                                } catch (error) {
                                    console.error("Erro ao fazer login inicial:", error);
                                    appState.isAuthReady = true;
                                } finally {
                                    renderApp();
                                }
                            })();
                        }
                    }
                    if (appState.isAuthReady) {
                        renderApp();
                        setupFirestoreListeners();
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                appState.isAuthReady = true;
                renderApp();
            }
        }
        
        // --- Listeners de Dados em Tempo Real ---
        function setupFirestoreListeners() {
             if (!appState.db || !appState.userId || !appState.selectedRole) return;
            
            // Listener para Fornecedores
            const suppliersRef = getCollectionRef('suppliers');
            onSnapshot(suppliersRef, (snapshot) => {
                const suppliersList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                appState.suppliers = suppliersList;
                renderApp(); // Re-renderiza após a atualização dos dados
            }, (error) => console.error("Erro ao carregar fornecedores:", error));

            // Listener para Requisições/Pedidos (OC)
            const requestsRef = getCollectionRef('requests');
            onSnapshot(requestsRef, (snapshot) => {
                const requestsList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    auditTrail: doc.data().auditTrail || [],
                    deliveries: doc.data().deliveries || [],
                    quantitiesReceived: doc.data().quantitiesReceived || 0,
                }));
                appState.requisitions = requestsList.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
                renderApp(); // Re-renderiza após a atualização dos dados
            }, (error) => console.error("Erro ao carregar requisições:", error));
        }

        // Expor funções essenciais ao escopo global para uso em onclick/event listeners
        window.handleTabChange = handleTabChange;
        window.showGlobalMessage = showGlobalMessage;

        // Inicia a aplicação após o carregamento do DOM
        window.onload = initApp;

    </script>
</body>
</html>
